<!DOCTYPE html>
<html lang="en">

<head>
	<title>Definir status</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!--===============================================================================================-->
	<link rel="icon" type="image/png" href="/assets/images1/logo.jpg" />
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="/assets/vendor/bootstrap/css/bootstrap.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="/assets/fonts/font-awesome-4.7.0/css/font-awesome.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="/assets/vendor/animate/animate.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="/assets/vendor/css-hamburgers/hamburgers.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="/assets/vendor/select2/select2.min.css">
	<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="/assets/css1/util.css">
	<link rel="stylesheet" type="text/css" href="/assets/css1/main.css">
	<!--===============================================================================================-->
</head>

<body>

	<div class="limiter" id="login">
		<div class="container-login100">
			<div class="wrap-login100">
				<div>
					<img width="100%" height="100%" src="assets/images1/ls.jpg" alt="IMG">
				</div>
				<center>
					<div class="login101-pic">
						<img style="border-radius: 50%;"
							src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/529582/img_avatar3.png" alt="IMG">
						<span class="login100-form-title" style="margin-top: 20px;">
							<%= user.first_name %>
								<%= user.last_name %>
						</span>
						<div class="text-center ">
							<a href="/exit_u"><button class="login10l-form-btn">
									DECONNEXION
								</button></a>
						</div>
						<div id="" style="display:block;margin-top: 50px;">
							<div class="wrap-input100 validate-input">
								<label for="exampleFormControlTextarea1" class="form-label">Remarque ou erreur sur
									l'application:</label>
								<textarea id="remarques" style="background: rgba(30, 152, 233, 0.5)"
									class="form-control" onfocus="empty()">
							</textarea>

							</div>
							<div class="wrap-input100 validate-input">
								<button id="bnt_rem" onclick="send_it()" class="login100-form-btn">
									ENVOYER
								</button>
							</div>
						</div>
					</div>
				</center>


				<div class="login100-form validate-form">
					<span id="time" class="login100-form-title">

					</span>
					<span class="login100-form-title">
						Definissez votre status
					</span>
					<div id="forgetpage" style="display:none;margin-top: 20px;">
						<div id="forget" class="alert alert-info" role="alert">
							Vous avez oublie de cliquer sur parti le :
						</div>
						<div class="wrap-input100 validate-input">
							<label for="exampleFormControlTextarea1" class="form-label">Vous avez quitté le travail à :
							</label>
							<input type="time" id="timeforget">
							</textarea>

						</div>
						<div class="wrap-input100 validate-input">
							<button id="bntsf" onclick="timeforget()" class="login100-form-btn">
								ENVOYER
							</button>
						</div>
					</div>
					<div id="latepage" style="display:none;margin-top: 20px;">
						<div id="late" class="alert alert-info" role="alert">
							Vous etes en retard de <%= retard %>
						</div>
						<div class="wrap-input100 validate-input">
							<label for="exampleFormControlTextarea1" class="form-label">La raison de votre retard
								:</label>
							<textarea id="latereason" style="background: rgba(30, 152, 233, 0.5)" class="form-control">
							</textarea>

						</div>
						<div class="wrap-input100 validate-input">
							<button id="bntsr" onclick="reason()" class="login100-form-btn">
								ENVOYER
							</button>
						</div>
					</div>
					<div id="statpage">
						<div class="wrap-input100 validate-input">

							<select id="locaux" class="input100" onchange="passed()" style="border-color: transparent;">
								<option value="Not defined">Ou vous etes ?</option>
								<option value="Tana Water Front">Tana Water Front</option>
								<option value="IKANO">IKANO</option>
								<option value="Travaille a domicile">Travaille à domicile</option>
								<option value="En dehors du bureau"> En dehors du bureau</option>
							</select>
							<br>
							<select id="hour" class="input100" onchange="passed()" style="border-color: transparent;">
								<option value="">Choisissez l'heure de travaille</option>
								<option value="6">6 heures</option>
								<option value="8">8 heures</option>
								<option value="10">10 heures</option>
							</select>
							<div id="info" style="display:none;margin-top: 20px;" class="alert alert-info" role="alert">
								Here is an information
							</div>
						</div>
						<br>
						<select id="changing_hour" class="input100" onchange="changing_hour()"
							style="border-color: transparent;display: none;">
							<option value="">Changer l'heure de travaille</option>
							<option value="6">6 heures</option>
							<option value="8">8 heures</option>
							<option value="10">10 heures</option>
						</select>
						<br>
						<div class="wrap-input100 validate-input">
							<button id="w" onclick="working()" class="login100-form-btn">
								TRAVAILLER
							</button>
						</div>
						<div class="wrap-input100">
							<select id="a" class="login10a-form-btn text-center" onchange="away()"
								style="border-color: transparent;">
								<option value="">ABSENT(E)</option>
								<option value="BREAK">Petit Break</option>
								<option value="DEJEUNER">Parti dejeuner</option>
								<option value="PAUSE">Parti en pause</option>
								<option value="ABSENT">Autre raison</option>
							</select>
							<div id="abr" class="wrap-input100 validate-input" style="display: none;">
								<label for="exampleFormControlTextarea1" class="form-label">La raison de votre absence
									:</label>
								<textarea id="awayreason" style="background: rgba(30, 152, 233, 0.5)"
									class="form-control">
							</textarea>
								<div class="row my-2">
									<div class="col-md-6">
										<button id="btnarp" onclick="away_complete()"
											class="login102s-form-btn float-left">
											PARTI
										</button>
									</div>
								</div>

							</div>
						</div>
						<div class="wrap-input100 validate-input">
							<!-- <button id="l" onclick="left()" class="login10l-form-btn">
							PARTI
						</button> -->
							<select id="l" class="login10l-form-btn text-center" onchange="left()"
								style="border-color: transparent;">
								<option value="">PARTI</option>
								<option value="POSTE">Changer de poste</option>
								<option value="IKANO">Deplacement chez IKANO</option>
								<option value="Tana Water Front">Deplacement chez TWF</option>
								<option value="Travaille a domicile">Changement en travaille à domicile</option>
								<option value="En dehors du bureau">Travailler en dehors du bureau</option>
								<option value="QUITTER">Fini pour aujourd'hui</option>
							</select>
						</div>
						<br>
						<span class="login100-form-title">
							STATUS ACTUEL
						</span>
						<div class="wrap-input100 validate-input">
							<center>
								<button id="s" class="login101-form-btn">

								</button>
							</center>
						</div>
					</div>
					<div id="denie" class="alert alert-danger" role="alert" style="display: none;margin-top: 20px;">

					</div>

					<div class="text-center p-t-136">
						<h1 class="txt2">
							Application Solumada, Copyright 2022
						</h1>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script src="/js_code/socket.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment-with-locales.min.js"></script>
	<script src="/js_code/momentz.js"></script>
	<script src="/js_code/timecontrole.js"></script>
	<script src="/js_code/workin.js"></script>

	<script>
		var retard = '<%= retard %>';
		var forget = '<%= forget %>';
		var user_occup = '<%= user.shift %>';
		forget_info = document.getElementById("forget");
		var forgetpage = document.getElementById("forgetpage");
		var latepage = document.getElementById("latepage");
		var statpage = document.getElementById("statpage");
		var abr = document.getElementById("abr");
		var btnars = document.getElementById("btnars");
		var btnarc = document.getElementById("btnarc");
		var err = document.getElementById("denie");
		remarques_field.textContent = "N'hésitez pas a écrire ici..";
		var get_hours = false;
		if (forget != "n") {
			forget = JSON.parse(forget.replace(/&#34;/g, '"'));
			forget_info.innerHTML += "<br>Le " + moment(forget.date).locale("Fr").format("dddd DD MMMM") +
				".<br>A commencé à " + forget.time_start + " pour " + forget.worktime + " heures.";
			forgetpage.style.display = "block";
			latepage.style.display = "none";
			statpage.style.display = "none";
		}
		else {
			if (retard != "n") {
				latepage.style.display = "block";
				statpage.style.display = "none";
			}
		}

		var socket = io();
		socket.on('date', function (dat) {
			clock.innerHTML = dat;
		})
		var locatenow = document.getElementById("locaux");
		if (user_occup.includes("SHIFT")) {

		}
		else {
			hour_today.value = 8;
			hour_today.style.display = "none";
			ch_heure.style.display = "none";
			get_hours = true;
		}
		var locaux = "<%= user.act_loc %>";
		document.getElementById("locaux").value = locaux;
		var awaystat = false;
		var status = "<%= user.act_stat %>";
		var ac_hour = "<%= user.user_ht %>";
		if (status == "WORKING") {
			awaystat = true;
			hour_today.value = ac_hour;
			hour_today.style.display = "none";
			workings();
			document.getElementById("s").innerHTML = "TRAVAILLER";
			senddata1();
		}
		else if (status == "LEFTING") {
			lefts();
			w.style.display = "none";
			a.style.display = "none";
			l.style.display = "none";
			document.getElementById("s").innerHTML = "NON DEFINI";
		}
		else {
			hour_today.value = ac_hour;
			awaystat = true;
			hour_today.style.display = "none";
			aways();
			document.getElementById("s").innerHTML = status;
			a.value = status;
			sendstatus(locatenow.value, status);
		}

		function working() {
			a.value = "";
			hour_today.style.display = "none";
			workings();

			if (awaystat == false) {
				senddata1();
			}
			else {
				senddata1();
				take_break();
			}
			awaystat = false;
			sendstatus(locatenow.value, "WORKING");
		}
		function left() {
			if (l.value == "QUITTER") {
				senddata2(document.getElementById("locaux").value);
				lefts();
				awaystat = false;
				sendstatus("Not defined", "LEFTING");
			}
			else if (l.value == "") {

			}
			else {

				senddata2_choice(document.getElementById("locaux").value, l.value);
				lefts();
				awaystat = false;
			}

		}
		function away() {
			hour_today.style.display = "none";
			if (a.value == "ABSENT") {
				abr.style.display = "block";
			}
			else {
				awaystat = true;
				abr.style.display = "none";
				aways();
				sendstatus(locatenow.value, a.value);
			}
		}
		function sendstatus(loc, stat) {
			var http = new XMLHttpRequest();
			http.open("POST", "/statuschange", true);
			http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			http.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200) {
					if (this.responseText == "error") {
						window.location = "/session_end";
					}
					else {
						switch (this.responseText.split(",")[0]) {
							case "WORKING": socket.emit("actuel", "TRAVAILLER" + ',' + '<%= user.m_code %>');
								socket.emit("loc", document.getElementById("locaux").value); break;
							case "LEFTING": socket.emit("actuel", "LEFTING" + ',' + '<%= user.m_code %>'); break;
							default: socket.emit("actuel", a.value + ',' + '<%= user.m_code %>'); senddata3(a.value); break;
						}
						if (this.responseText.split(",")[0] == "DEJEUNER" || this.responseText.split(",")[0] == "PAUSE" || this.responseText.split(",")[0] == "BREAK") {
							var delay = "";
							switch (this.responseText.split(",")[0]) {
								case "DEJEUNER": delay = " <br> Revenez à " + moment(this.responseText.split(",")[1], "HH:mm").add(30, "minutes").format("HH:mm"); break;
								case "PAUSE": delay = " <br> Revenez à " + moment(this.responseText.split(",")[1], "HH:mm").add(15, "minutes").format("HH:mm"); break;
								case "BREAK": delay = " <br> Revenez quand vous allez mieux."; break;
							}
							info.innerHTML = "Vous avez pris votre " + this.responseText.split(",")[0].toLowerCase() + " à " + this.responseText.split(",")[1] + delay;
						}
					}

				}
			};
			http.send("act_loc=" + loc + "&act_stat=" + stat);
		}
		var latereason = document.getElementById("latereason");
		function reason() {
			if (latereason.value.trim() != "") {
				err.style.display = "none";
				sendreason("/reason", latereason.value.trim());
			}
			else {
				err.innerHTML = "Le champ ne peut pas être vide";
				err.style.display = "block";
			}
		}
		var timeforgets = document.getElementById("timeforget");
		function timeforget() {
			if (timeforgets.value != "") {
				err.style.display = "none";
				forgettime("/forget", timeforgets.value);
			}
			else {
				err.innerHTML = "Le champ ne peut pas être vide";
				err.style.display = "block";
			}
		}
		function take_break() {
			var http = new XMLHttpRequest();
			http.open("POST", "/takebreak", true);
			http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			http.onreadystatechange = function () {
			};
			http.send();
		}
		function sendreason(url, reasons) {
			var http = new XMLHttpRequest();
			http.open("POST", url, true);
			http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			http.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200) {
					latepage.style.display = "none";
					statpage.style.display = "block";
				}
			};
			http.send("reason=" + reasons);
		}
		function passed() {
			if (locatenow.value != "Not defined" && hour_today.value != "") {
				w.style.display = "block";
				a.style.display = "block";
				l.style.display = "block";
				a.disabled = true;
				l.disabled = true;
				sendhour("/gethour", hour_today.value);
				w.click();
			}
			else {
				if (get_hours) {
					w.style.display = "block";
					a.style.display = "block";
					l.style.display = "block";
					a.disabled = true;
					l.disabled = true;
					sendhour("/gethour", hour_today.value);
					w.click();
				}
				else {
					w.style.display = "none";
					a.style.display = "none";
					l.style.display = "none";
				}
			}
		}
		function changing_hour() {
			if (ch_heure.value != "") {
				send_changing_hour();
			}
		}
		function send_it() {
			if (remarques_field.value != "") {
				send_rem('<%= user.m_code %>', remarques_field.value);
			}
		}
		var awayreason = document.getElementById("awayreason");
		function away_complete() {
			if (awayreason.value.trim() != "") {
				err.style.display = "none";
				sendawayreason("/absent", awayreason.value.trim(), "complete");
			}
			else {
				err.innerHTML = "Le champ ne peut pas être vide";
				err.style.display = "block";
			}

		}
		function sendawayreason(url, areasons, stat) {
			var http = new XMLHttpRequest();
			http.open("POST", url, true);
			http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			http.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200) {
					if (this.responseText == "complete") {
						window.location = "/exit_u";
					}
					else if (this.responseText == "error") {
						window.location = "/session_end";
					}
				}
			};
			http.send("reason=" + areasons + "&stat=" + stat);
		}
		function sendhour(url, ht) {
			var http = new XMLHttpRequest();
			http.open("POST", url, true);
			http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			http.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200) {

				}
			};
			http.send("hour=" + ht);
		}
		function forgettime(url, tf) {
			var http = new XMLHttpRequest();
			http.open("POST", url, true);
			http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			http.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200) {
					if (this.responseText == "No") {
						err.innerHTML = "L'heure de travail dépasse le " + forget.worktime + " heures choisi";
						err.style.display = "block";
					}
					else if (this.responseText == "error") {
						window.location = "/session_end";
					}
					else {
						window.location = "/employee";
					}
				}
			};
			http.send("timeforget=" + tf);
		}
		function clockRunner() {
			clock.innerHTML = moment().tz("Europe/Amsterdam").locale("Fr").add(2, "hours").format("dddd DD MMMM HH:mm:ss");
			setTimeout(clockRunner, 1000);
		}
		window.onload = clockRunner();
	</script>
	<script src="/assets/vendor/jquery/jquery-3.2.1.min.js"></script>
	<!--===============================================================================================-->
	<script src="/assets/vendor/bootstrap/js/popper.js"></script>
	<script src="/assets/vendor/bootstrap/js/bootstrap.min.js"></script>
	<!--===============================================================================================-->
	<script src="/assets/vendor/select2/select2.min.js"></script>
	<!--===============================================================================================-->
	<script src="/assets/vendor/tilt/tilt.jquery.min.js"></script>
	<!--===============================================================================================-->
	<script src="/assets/js1/main.js"></script>

</body>

</html>